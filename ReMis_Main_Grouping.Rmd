---
title: "ReMis_Main_Grouping"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Load packages
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(writexl)
library(readxl)
library(qdap)
library(DiagrammeR) # For the flowchart
library(grid) # For the flowchart
library(Gmisc) # For the flowchart
```

# Grouping the responses
## Reading in processed data
```{r}
processed <- read_tsv("Processed/ReMis_Main_Processed_data.tsv")
```

## Preparation for grouping
### Writing responses to a spreadsheet for dividing more answer in one response to several columns
```{r}
# Data management mistakes
processed %>%
  transmute(response_id,
            recurring_story,
            serious_story) %>% 
  gather(key = "mistake_type", value = "mistake", -response_id) %>% 
  mutate(mistake_type = str_extract(mistake_type, "[^_]+"),
         mistake_1 = NA_character_,
         mistake_2 = NA_character_) 
 # write_xlsx(., "Processed/ReMis_Main_Processed_Mistake_data.xlsx")

# Causes of mistakes
processed %>% 
  transmute(response_id,
            recurring_cause,
            serious_cause,
            code) %>% 
  gather(key = "cause_type", value = "cause", -response_id) %>% 
  mutate(cause_type = str_extract(cause_type, "[^_]+"),
         cause_1 = NA_character_,
         cause_2 = NA_character_)
  #write_xlsx(., "Processed/ReMis_Main_Processed_Cause_data.xlsx")

# Outcomes of mistakes
processed %>% 
  transmute(response_id,
            recurring_outcome,
            serious_outcome) %>% 
  gather(key = "outcome_type", value = "outcome", -response_id) %>% 
  mutate(outcome_type = str_extract(outcome_type, "[^_]+"),
         outcome_1 = NA_character_)
 # write_xlsx(., "Processed/ReMis_Main_Processed_Outcome_data.xlsx")
```

### Read in separated responses and transform them for coding
```{r}
# Data management mistakes stages
## There will be no coding for the stages.

# Data management mistake types
## Read in data
# processed_mistake_data <- read_xlsx("Processed/ReMis_Main_Processed_Mistake_data.xlsx")

## Transform data
processed_mistake_data <- processed_mistake_data %>% 
  gather(key = "mistake_no", value = "mistakes_sep", -response_id, -mistake_type, -mistake) %>%
  mutate(mistake_no = str_extract(mistake_no, "[0-9]$"),
         code = NA_character_,
         mistake_sep = case_when(is.na(mistake_sep) ~ "missing",
                                 TRUE ~ mistake_sep))

## Write data
#processed_mistake_data %>% 
#  write_xlsx(., "Processed/ReMis_Main_Processed_Mistake_Type_Coding_data.xlsx")

# Causes of mistakes
## Read in data
# processed_cause_data <- read_xlsx("Processed/ReMis_Main_Processed_Cause_data.xlsx")

## Transform data
processed_cause_data <- processed_cause_data %>% 
  gather(key = "cause_no", value = "cause_sep", -response_id, -cause_type, -cause) %>%
  mutate(cause_no = str_extract(cause_no, "[0-9]$"),
         code = NA_character_,
         cause_sep = case_when(is.na(cause_sep) ~ "missing",
                                 TRUE ~ cause_sep))

## Write data
#processed_cause_data %>% 
 # write_xlsx(., "Processed/ReMis_Main_Processed_Cause_Coding_data.xlsx")

# Outcomes of mistakes
## Read in data
processed_outcome_data <- read_xlsx("Processed/ReMis_Main_Processed_Outcome_data.xlsx")

## Transform data
processed_outcome_data <- processed_outcome_data %>% 
  gather(key = "outcome_no", value = "outcome_sep", -response_id, -outcome_type, -outcome) %>%
  mutate(outcome_no = str_extract(outcome_no, "[0-9]$"),
         code = NA_character_) %>% 
  drop_na(outcome_sep)

## Write data
processed_outcome_data %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Outcome_Coding_data.xlsx")
```

### Read in coded responses and summarise the codes for creating groupes
```{r}
# Data management mistake types
## Read in data
processed_mistake_type_coding <-
  read_xlsx("Processed/coding/ReMis_Main_Processed_Mistake_Type_Coding_data.xlsx")

processed_mistake_type_coding %>% 
  group_by(code) %>%
  count() %>% 
  mutate(group = NA_character_) %>%
  arrange(code) %>%
  write_xlsx(., "Processed/ReMis_Main_Processed_Mistake_Type_Grouping.xlsx")

# Causes of mistakes
## Read in data
processed_cause_coding <-
  read_xlsx("Processed/coding/ReMis_Main_Processed_Cause_Coding_data.xlsx")

processed_cause_coding %>% 
  group_by(code) %>%
  count() %>%
  mutate(group = NA_character_) %>% 
  arrange(code) %>%
  write_xlsx(., "Processed/ReMis_Main_Processed_Cause_Grouping.xlsx")

# Outcomes of mistakes
## Read in data
processed_outcome_coding <-
  read_xlsx("Processed/coding/ReMis_Main_Processed_Outcome_Coding_data.xlsx")

processed_outcome_coding %>% 
  group_by(code) %>%
  count() %>%
  mutate(group = NA_character_) %>% 
  arrange(code) %>%
  write_xlsx(., "Processed/ReMis_Main_Processed_Outcome_Grouping.xlsx")
```

# Read in the results of grouping and create the definition of the groups from the codes that are in the group
```{r}
# Data management mistake types
processed_mistake_type_grouping <- read_xlsx("Processed/grouping/ReMis_Main_Processed_Mistake_Type_Grouping.xlsx")

processed_mistake_type_grouping %>% 
  filter(group != "NA") %>% 
  group_by(group) %>% 
  summarise(definition = str_c(code, collapse = "; ")) %>% 
  mutate(definition = tolower(definition)) %>% 
  write_xlsx(., "Processed/definition/ReMis_Main_Processed_Mistake_Type_Definition.xlsx")

# Causes of mistakes
processed_cause_grouping <- read_xlsx("Processed/grouping/ReMis_Main_Processed_Cause_Grouping.xlsx")

processed_cause_grouping %>% 
  filter(group != "NA") %>% 
  group_by(group) %>% 
  summarise(definition = str_c(code, collapse = "; ")) %>% 
  mutate(definition = tolower(definition)) %>% 
  write_xlsx(., "Processed/definition/ReMis_Main_Processed_Cause_Definition.xlsx")

# Outcomes of mistakes
processed_outcome_grouping <- read_xlsx("Processed/grouping/ReMis_Main_Processed_Outcome_Grouping.xlsx")

processed_outcome_grouping %>% 
  filter(group != "NA") %>% 
  group_by(group) %>% 
  summarise(definition = str_c(code, collapse = "; ")) %>% 
  mutate(definition = tolower(definition)) %>% 
  write_xlsx(., "Processed/definition/ReMis_Main_Processed_Outcome_Definition.xlsx")
```

### Create data with excluded responses
```{r}
# Data management mistake stages
processed_mistake_stage_filtered <-
  processed_mistake_type_coding %>% 
  filter(code %ni% c("irrelevant content",
                     "missing",
                     "out of timeframe",
                     "see above"))

# Data management mistake types
processed_mistake_type_filtered <-
  processed_mistake_type_coding %>% 
  left_join(., processed_mistake_type_grouping, by = "code") %>% 
  filter(group != "NA") %>%
  select(-code, -n, -group)

# Causes of mistakes
processed_cause_filtered <-
  processed_cause_coding %>% 
  left_join(., processed_cause_grouping, by = "code") %>% 
  filter(group != "NA") %>%
  select(-code, -n, -group)

# Outcomes of mistakes
processed_outcome_filtered <-
  processed_outcome_coding %>% 
  left_join(., processed_outcome_grouping, by = "code") %>% 
  filter(group != "NA") %>%
  select(-code, -n, -group)
```

### Writing responses to spreadsheets for the raters
```{r}
# Data management mistake stages
## Rater1
processed_mistake_stage_filtered %>% 
  mutate(group_rater1 = NA_character_) %>% 
  slice(1:418) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Stage_Rater1_data.xlsx")

## Rater2
processed_mistake_stage_filtered %>% 
  mutate(group_rater2 = NA_character_) %>% 
  slice(1:418) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Stage_Rater2_data.xlsx")

## Rater3
processed_mistake_stage_filtered %>% 
  mutate(group_rater3 = NA_character_) %>% 
  slice(419:837) %>%
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Stage_Rater3_data.xlsx")

## Rater4
processed_mistake_stage_filtered %>% 
  mutate(group_rater4 = NA_character_) %>% 
  slice(419:837) %>%
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Stage_Rater4_data.xlsx")

# Data management mistake types
## Rater1
processed_mistake_type_filtered %>% 
  mutate(group_rater1 = NA_character_) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Type_Rater1_data.xlsx")

## Rater2
processed_mistake_type_filtered %>% 
  mutate(group_rater2 = NA_character_) %>% 
  slice(1:599) %>%
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Type_test_data.xlsx")

## Rater3
processed_mistake_type_filtered %>% 
  mutate(group_rater3 = NA_character_) %>%
  slice(600:786) %>%
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Type_Rater3_data.xlsx")

## Rater4
processed_mistake_type_filtered %>% 
  mutate(group_rater4 = NA_character_) %>% 
  slice(600:786) %>%
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Type_Rater4_data.xlsx")

# Causes of mistakes
## Rater1
processed_cause_filtered %>% 
  mutate(group_rater1 = NA_character_) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Cause_Rater1_data.xlsx")

## Rater2
processed_cause_filtered %>% 
  mutate(group_rater2 = NA_character_) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Cause_Rater2_data.xlsx")

# Outcomes of mistakes
## Rater1
processed_outcome_filtered %>% 
  mutate(group_rater1 = NA_character_) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Outcome_Rater1_data.xlsx")

## Rater2
processed_mistake_type_filtered %>% 
  mutate(group_rater2 = NA_character_) %>% 
  write_xlsx(., "Processed/rating/ReMis_Main_Processed_Outcome_Rater2_data.xlsx")
```

## Checking the results of the validation of grouping
## Import data
```{r}
### Data management mistake stages
#### Rater 1
processed_grouping_stage_rater1 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Stage_Rater1_data.xlsx")

#### Rater 2
processed_grouping_stage_rater2 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Stage_Rater2_data.xlsx")

#### Rater 3
processed_grouping_stage_rater3 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Stage_Rater3_data.xlsx")

#### Rater 4
processed_grouping_stage_rater4 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Stage_Rater4_data.xlsx")

### Data management mistake types
#### Rater 1
processed_grouping_type_rater1 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Type_Rater1_data.xlsx")

#### Rater 2
processed_grouping_type_rater2 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Type_Rater2_data.xlsx")

#### Rater 3
processed_grouping_type_rater3 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Type_Rater3_data.xlsx")

#### Rater 4
processed_grouping_type_rater4 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Type_Rater4_data.xlsx")

### Causes of mistakes
#### Rater 1
processed_grouping_cause_rater1 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Cause_Rater1_data.xlsx")

#### Rater 2
processed_grouping_cause_rater2 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Cause_Rater2_data.xlsx")

### Outcomes of mistakes
#### Rater 1
processed_grouping_outcome_rater1 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Outcome_Rater1_data.xlsx")

#### Rater 2
processed_grouping_outcome_rater2 <-
  read_xlsx("Processed/rated/ReMis_Main_Processed_Outcome_Rater2_data.xlsx")

```

## Merging grouped dataframes
```{r}
### Data management mistake stages
processed_grouping_stage_1 <- left_join(processed_grouping_stage_rater1, processed_grouping_stage_rater2, by = c("response_id", "mistake_type", "mistake", "mistake_no", "mistakes_sep"))

processed_grouping_stage_2 <- left_join(processed_grouping_stage_rater3, processed_grouping_stage_rater4, by = c("response_id", "mistake_type", "mistake", "mistake_no", "mistakes_sep"))

### Data management mistake types
processed_grouping_type_1 <- left_join(processed_grouping_type_rater1, processed_grouping_type_rater2, by = c("response_id", "mistake_type", "mistake", "mistake_no", "mistakes_sep"))

processed_grouping_type_2 <- left_join(processed_grouping_type_rater3, processed_grouping_type_rater4, by = c("response_id", "mistake_type", "mistake", "mistake_no", "mistakes_sep"))

### Causes of mistakes
processed_grouping_cause <- left_join(processed_grouping_cause_rater1, processed_grouping_cause_rater2, by = c("response_id", "cause_type", "cause", "cause_no", "cause_sep"))

### Outcomes of mistakes
processed_grouping_outcome <- left_join(processed_grouping_outcome_rater1, processed_grouping_outcome_rater2, by = c("response_id", "outcome_type", "outcome", "outcome_no", "outcome_sep"))
```

## Matching ratings
```{r}
### Data management mistake stages
processed_grouping_stage_match_1 <- 
  processed_grouping_stage_1 %>% 
  mutate(match = case_when(group_rater1 == group_rater2 ~ 1L,
                           group_rater1 != group_rater2 ~ 0L),
         group_final = NA_character_)

processed_grouping_stage_match_2 <- 
  processed_grouping_stage_2 %>% 
  mutate(match = case_when(group_rater3 == group_rater4 ~ 1L,
                           group_rater3 != group_rater4 ~ 0L),
         group_final = NA_character_)

### Data management mistake types
processed_grouping_type_match_1 <- 
  processed_grouping_type_1 %>% 
  mutate(match = case_when(group_rater1 == group_rater2 ~ 1L,
                           group_rater1 != group_rater2 ~ 0L),
         group_final = NA_character_)

processed_grouping_type_match_2 <- 
  processed_grouping_type_2 %>% 
  mutate(match = case_when(group_rater3 == group_rater4 ~ 1L,
                           group_rater3 != group_rater4 ~ 0L),
         group_final = NA_character_)

### Causes of mistakes
processed_grouping_cause_match <- 
  processed_grouping_cause %>% 
  mutate(match = case_when(group_rater1 == group_rater2 ~ 1L,
                           group_rater1 != group_rater2 ~ 0L),
         group_final = NA_character_)

### Outcomes of mistakes
processed_grouping_outcome_match <- 
  processed_grouping_outcome %>% 
  mutate(match = case_when(group_rater1 == group_rater2 ~ 1L,
                           group_rater1 != group_rater2 ~ 0L),
         group_final = NA_character_)
```

## Write matching rating results for discussion
```{r}
### Data management mistake stages
processed_grouping_stage_match_1 %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Grouping_Stage_Match_1_data.xlsx")

processed_grouping_stage_match_2 %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Grouping_Stage_Match_2_data.xlsx")

### Data management mistake types
processed_grouping_type_match_1 %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Grouping_Type_Match_1_data.xlsx")

processed_grouping_type_match_2 %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Grouping_Type_Match_2_data.xlsx")

### Causes of mistakes
processed_grouping_cause_match %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Grouping_Cause_Match_data.xlsx")

### Outcomes of mistakes
processed_grouping_outcome_match %>% 
  write_xlsx(., "Processed/ReMis_Main_Processed_Grouping_Outcome_Match_data.xlsx")
```

# Read in final groups after discussion
```{r}
## Data management mistake stages
processed_grouping_stage_result_1 <-
  read_xlsx("Processed/grouping/match/ReMis_Main_Processed_Grouping_Stage_Match_1_data.xlsx")

processed_grouping_stage_result_2 <-
  read_xlsx("Processed/grouping/match/ReMis_Main_Processed_Grouping_Stage_Match_2_data.xlsx")

## Data management mistake types
processed_grouping_type_result_1 <-
  read_xlsx("Processed/grouping/match/ReMis_Main_Processed_Grouping_Type_Match_1_data.xlsx")

processed_grouping_type_result_2 <-
  read_xlsx("Processed/grouping/match/ReMis_Main_Processed_Grouping_Type_Match_2_data.xlsx")

## Causes of mistakes
processed_grouping_cause_result <-
  read_xlsx("Processed/grouping/match/ReMis_Main_Processed_Grouping_Cause_Match_data.xlsx")

## Outcomes of mistakes
processed_grouping_outcome_result <-
  read_xlsx("Processed/grouping/match/ReMis_Main_Processed_Grouping_Outcome_Match_data.xlsx")
```

# Merge final groups of the same question
```{r}
## Data management mistake stages
processed_grouping_stage_result_1 <-
  processed_grouping_stage_result_1 %>% 
  mutate(group_final = case_when(is.na(group_final) & match == 1L ~ group_rater1,
                                 TRUE ~ group_final),
         group_stage = group_final) %>% 
  select(-group_final, -group_rater1, -group_rater2, -match)

processed_grouping_stage_result_2 <-
  processed_grouping_stage_result_2 %>% 
  mutate(group_final = case_when(is.na(group_final) & match == 1L ~ group_rater3,
                                 TRUE ~ group_final),
         group_stage = group_final) %>% 
  select(-group_final, -group_rater3, -group_rater4, -match)

processed_grouping_stage_result <-
  processed_grouping_stage_result_1 %>% 
  bind_rows(., processed_grouping_stage_result_2) %>% 
  mutate(type = mistake_type) %>% 
  select(-mistake_type)

## Data management mistake types
processed_grouping_type_result_1 <-
  processed_grouping_type_result_1 %>% 
  mutate(group_final = case_when(is.na(group_final) & match == 1L ~ group_rater1,
                                 TRUE ~ group_final),
         group_type = group_final) %>% 
  select(-group_final, -group_rater1, -group_rater2, -match)

processed_grouping_type_result_2 <-
  processed_grouping_type_result_2 %>% 
  mutate(group_final = case_when(is.na(group_final) & match == 1L ~ group_rater3,
                                 TRUE ~ group_final),
         group_type = group_final) %>% 
  select(-group_final, -group_rater3, -group_rater4, -match)

processed_grouping_type_result <-
  processed_grouping_type_result_1 %>% 
  bind_rows(., processed_grouping_type_result_2) %>% 
  mutate(type = mistake_type) %>% 
  select(-mistake_type)

## Causes of mistakes
processed_grouping_cause_result <-
  processed_grouping_cause_result %>% 
  mutate(group_final = case_when(is.na(group_final) & match == 1L ~ group_rater1,
                                 TRUE ~ group_final),
         group_cause = group_final,
         type = cause_type) %>% 
  select(-group_final, -group_rater1, -group_rater2, -match, -cause_type)
 

## Outcomes of mistakes
processed_grouping_outcome_result <-
  processed_grouping_outcome_result %>% 
  mutate(group_final = case_when(is.na(group_final) & match == 1L ~ group_rater1,
                                 TRUE ~ group_final),
         group_outcome = group_final,
         type = outcome_type) %>% 
  select(-group_final, -group_rater1, -group_rater2, -match, -outcome_type)
```

# Save final group data
```{r}
## Data management mistake stages
processed_grouping_stage_result %>% 
  write_tsv(., "Processed/ReMis_Main_Processed_Stage_Groups_data.tsv")

## Data management mistake types
processed_grouping_type_result %>% 
  write_tsv(., "Processed/ReMis_Main_Processed_Type_Groups_data.tsv")

## Causes of mistakes
processed_grouping_cause_result %>% 
  write_tsv(., "Processed/ReMis_Main_Processed_Cause_Groups_data.tsv")

## Outcomes of mistakes
processed_grouping_outcome_result %>% 
  write_tsv(., "Processed/ReMis_Main_Processed_Outcome_Groups_data.tsv")
```

# Flowchart depicting the steps of the grouping process
```{r}
# See templates: https://github.com/aghaynes/misc/blob/master/flow_template.R
# https://rstudio-pubs-static.s3.amazonaws.com/90261_ad00e95221e14a33a50f2ebb56d34ab8.html
# https://davetang.org/muse/2017/03/31/creating-flowchart-using-r/

# Create the nodes
nodes <-
  create_node_df(
    n = 7,
    label = c("Responses",
              "Separated responses",
              "Grouping",
              "Ungrouped responses",
              "Grouped responses",
              "Codes",
              "Groups"),
    type = "lower",
    style = "filled",
    color = "grey",
    shape = rep("rectangle", 7)
  )

# Create edges
edges <-
  create_edge_df(
    from = c(1, 2, 2, 3, 3, 6),
    to = c(2, 3, 6, 4, 5, 7),
    rel = "related")

# Create the graph
flowchart <- create_graph(nodes_df = nodes,
                          edges_df = edges)

# See the graph
render_graph(flowchart)
```