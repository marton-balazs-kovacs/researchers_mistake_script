---
title: "ReMis Main Raw Processed"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load packages

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(writexl)
library(readxl)
library(zoo)
library(qdap)
```

# Load functions

```{r}
source("utils.R")
```

# Transforming Raw data to be ready for the thematic grouping
## Import data

```{r, message = FALSE, warning = FALSE}
raw <- read_tsv("Raw/ReMis_Main_Raw_data.tsv")
```

## Converting the varaible names to clean format

```{r}
raw <-
  raw %>% 
  janitor::clean_names()
```

## Data filtering
### Delete rows created by Qualtrics for variable explanation

```{r}
raw <- 
  raw %>%
  slice(-(1:2))
```

The number of responses: `r response_count(raw)`

### Checking the number of responses from each distribution channel

The survey was filled out by respondents outside of our sample as some respondents redestributed the survey link among their collagues. These responses are marked as "anonymous" by Qualtrics in the Distribution channel variable. Whereas the survey that we sent to our sample is marked by "email".

```{r}
distrib_channel_count <- 
  raw %>%
  group_by(distribution_channel) %>%
  count()
```

We recieved `r filter(distrib_channel_count, distribution_channel == "anonymous") %>% pull(n)` answers from the redistribution of our survey. As we do not know who provided these responses we exclude them from further analysis.

```{r}
raw <-
  raw %>% 
  filter(distribution_channel != "anonymous")
```

The number of responses: `r response_count(raw)`

### Delete trial responses

There are responses that were provided by the authors during the testing of the survey. These responses are excluded from further analysis.

```{r}
trial_respones <- c("R_2v2lOblGkxW8bzU", "R_OsbjDax8tZ9HrBD", "R_3haoYfua4zboVyb", "R_2xEmpKqvv1joVTT")

raw <- 
  raw %>%
  filter(response_id %ni% trial_respones)
```

The number of responses: `r response_count(raw)`

### Delete respondents who did not accept the informed consent form

We exclude respondents who did not accept the informed consent form in the beggining of our survey from any further analysis.

The number of respondents who did and did not accept the informed consent form:

```{r}
raw %>%
  group_by(inform) %>% 
  summarise(n = n())
```

```{r}
raw <- raw %>%
  filter(inform == "Yes")
```

The number of responses: `r response_count(raw)`

### Delete respondents who did not answer any question

When saving the responses of the survey from Qualtrics we downloaded the responses in progress alongside the completed responses. Therefore, we exclude the responses where the respondent did not answer any questions of the survey.

```{r}
questions <- colnames(raw)[12:26]

raw_no_answer <- 
  raw %>% 
  filter_at(vars(questions), all_vars(is.na(.)))
```

The number of responses where the respondent did not answer any question: `r response_count(raw_no_answer)`

```{r}
raw <- 
  raw %>%
  filter_at(vars(questions), any_vars(!is.na(.)))
```

The number of responses: `r response_count(raw)`

## Calucalting median response time

We are calculating the median completition time of the survey based on the responses that we had after exclusion.

```{r}
raw %>% 
  mutate(response_time_sec = as.numeric(duration_in_seconds)) %>% 
  summarise(median_response_time_min = median(response_time_sec) / 60,
            iqr_response_time = stats::IQR(response_time_sec),
            quantile_response_time_3 = quantile(response_time_sec, 0.75),
            quantile_response_time_1 = quantile(response_time_sec, 0.25),
            min_response_time = min(response_time_sec),
            max_response_time = max(response_time_sec))
```

## Variable transformation

We are combining the free text response that respondents provided when they chose not to select a preset option with the selected preset answers.

```{r}
raw <- 
  raw %>%
  mutate(years = as.integer(years),
         recurring_outcome = case_when(recurring_outcome == "other" ~ recurring_outcome_6_text,
                                          TRUE ~ recurring_outcome),
         serious_outcome = case_when(serious_outcome == "other" ~ serious_outcome_6_text,
                                          TRUE ~ serious_outcome))
```

We are keeping only the level description of the Likert-scale variables but not their explanation.

```{r}
raw <- 
  raw %>%
  mutate(general_frequency = beg2char(general_frequency, "\n"),
         recurring_frequency = beg2char(recurring_frequency, "\n"),
         recurring_serious = beg2char(recurring_serious, "\n"),
         serious_serious = beg2char(serious_serious, "\n"))
```

## Filter the needed variables only

We are dropping the variables that will not be used in further analysis.

```{r}
raw <- 
  raw %>%
  select(-start_date, -end_date, -status,
         -progress, -duration_in_seconds, -finished,
         -recorded_date, -distribution_channel, -user_language,
         -inform, -comment, -serious_outcome_6_text,
         -recurring_outcome_6_text)
```

# Saving the data for the thematic grouping

```{r}
raw %>%
  write_tsv(., "Processed/ReMis_Main_Processed_data.tsv")
```