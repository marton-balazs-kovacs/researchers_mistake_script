---
title: "ReMis Main Creatin Analysis Ready Data"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Load packages

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(writexl)
library(readxl)
library(zoo)
library(qdap)
```

# Load functions

```{r}
source("utils.R")
```

# Import data

```{r}
# Processed data
processed <- 
  read_tsv("Processed/ReMis_Main_Processed_data.tsv")

# Mistake type coding
processed_type_coding <-
  read_xlsx("Processed/grouping/coding/ReMis_Main_Processed_Mistake_Type_Coding_data.xlsx") 

# Mistake type groups
processed_type_groups <- 
  read_tsv("Processed/ReMis_Main_Processed_Type_Groups_data.tsv")

# Causes of mistakes groups
processed_cause_groups <-
  read_tsv("Processed/ReMis_Main_Processed_Cause_Groups_data.tsv")

# Outcomes of mistakes groups
processed_outcome_groups <-
  read_tsv("Processed/ReMis_Main_Processed_Outcome_Groups_data.tsv")

# Mistake stage groups
processed_stage_groups <- 
  read_tsv("Processed/ReMis_Main_Processed_Stage_Groups_data.tsv")
```

# Create individual datatables for further analysis
## Create datatable for the descriptive information
### Select needed variables

```{r}
processed_descriptives <- 
  processed %>%
  select(response_id,
         years,
         field)
```

### Write processed datafile for analysis

```{r}
# write_tsv(processed_descriptives, "Processed/ReMis_Main_Processed_Descriptive_Analysis_data.tsv")
```

## Create datatable for general frequency of mistakes in teams
### Select needed variables

```{r}

processed_general_frequency <- 
  processed %>%
  select(response_id,
         general_frequency)
```

### Write processed datafile for analysis

```{r}
# write_tsv(processed_general_frequency, "Processed/ReMis_Main_Processed_General_Frequency_Analysis_data.tsv")
```

## Create datatable for general overview of data management mistakes (seriousness and frequency ratings of mistakes)
### Investigating the excluded responses
#### Create a table of the excluded responses

```{r}
exclude <-  
  processed_type_coding %>%
  filter(code %in% c("see above",
                     "missing",
                     "irrelevant content",
                     "out of timeframe")) %>%
  mutate(exclusion_criteria = code,
         type = mistake_type) %>%
  select(response_id, type, mistake, exclusion_criteria) %>% 
  distinct(response_id, type, .keep_all = TRUE)
```

#### Number of mistake responses that we exclude (and the reason why)

```{r}
exclude %>% 
  group_by(exclusion_criteria, type) %>% 
  count() %>% 
  group_by(type) %>% 
  mutate(sum = sum(n)) %>%
  knitr::kable(caption = "The exclusion criteria and the number of responses excluded because of that")
```

### Transforming data
#### Creating temporary datatable for storing mistake descriptions

```{r}
temp_story <- 
  processed %>% 
  select(response_id, recurring_story, serious_story) %>%
  gather(key = "type", value = "mistake", -response_id) %>% 
  mutate(type = str_extract(type, "[^_]+"))
```

#### Number of all mistake response stories before exclusion

```{r}
temp_story %>% 
  filter(!is.na(mistake)) %>% 
  group_by(type) %>% 
  count()
```

#### Creating temporary datatable for storing mistake ratings

```{r}
temp_rating <-
  processed %>%
  select(response_id, recurring_frequency, recurring_serious, serious_serious) %>% 
  gather(key = "key", value = "rating", -response_id) %>% 
  separate(key, into = c("type", "question"), sep = "_")
```

#### Number of all mistake response ratings before exclusion

```{r}
temp_rating %>% 
  filter(!is.na(rating)) %>% 
  group_by(type, question) %>% 
  count()
```

#### Joining ratings to the descriptions of the mistakes

```{r}
processed_mistake_general <-
  temp_story %>% 
  left_join(., temp_rating, by = c("response_id", "type"))
```

#### Number of individual respondents before exclusion

```{r}
processed_mistake_general %>% 
  distinct(response_id) %>% 
  count()
```

#### Responses that will be excluded and their ratings

```{r}
processed_mistake_general_exclude <- 
  processed_mistake_general %>% 
  inner_join(., exclude, by = c("response_id", "type", "mistake"))
```

#### Number of responses that will be excluded per type and question

```{r}
processed_mistake_general_exclude %>% 
  group_by(type, question) %>% 
  count()
```

#### Excluding trials

```{r}
processed_mistake_general_excluded <-
  processed_mistake_general %>% 
  anti_join(., exclude, by = c("response_id", "type", "mistake"))
```

#### Number of all mistake response ratings

```{r}
processed_mistake_general_excluded %>% 
  group_by(type, question) %>% 
  count()
```

#### Number of missing ratings after exclusion

```{r}
processed_mistake_general_excluded %>% 
  filter(is.na(rating)) %>% 
  group_by(type, question) %>% 
  count()
```

#### Number of individual respondents left after exclusion

```{r}
processed_mistake_general_excluded %>% 
  distinct(response_id) %>%
  count()
```

#### Write processed datafile for analysis

```{r}
# write_tsv(processed_mistake_general_excluded, "Processed/ReMis_Main_Processed_Mistake_General_Analysis_data.tsv")
```

## Create datatable for exploring the relationship between mistake causes and types

We keep every case where there is only one cause. It is possible that the respondent reported several causes but during the grouping process we dropped all of the causes except one. In that case, that one cause will be associated with the mnistake type.

### Counting the number of causes before exclusion 

```{r}
processed_cause_groups %>% 
  group_by(type) %>% 
  count()
```

### Filtering causes for the plot

```{r}
processed_cause_groups_filtered <-
  processed_cause_groups %>%
  group_by(response_id, type) %>%
  mutate(n_cause = n()) %>% 
  filter(n_cause == 1)
```

### Counting the number of causes after exclusion

```{r}
processed_cause_groups_filtered %>% 
  group_by(type) %>% 
  count()
```

### Counting the number of mistake types before exclusion

```{r}
processed_type_groups %>% 
  group_by(type) %>% 
  count()
```

### Filtering mistake types for the plot

For the mistake type filtering we keep only the cases where the respondent only wrote one mistake.

```{r}
processed_type_groups_filtered  <-
  processed_type_groups %>% 
  group_by(response_id, type) %>%
  slice(which.max(mistake_no)) %>%
  filter(mistake_no == 1)
```

### Counting the number of mistake types after exclusion

```{r}
processed_type_groups_filtered %>% 
  group_by(type) %>% 
  count()
```


### Create the datatable

```{r}
processed_cause_type_relationship <-
  processed_type_groups_filtered %>% 
  inner_join(., processed_cause_groups_filtered, by = c("response_id", "type")) %>% 
  select(response_id, type, mistake, mistake_no, mistake_sep, group_type, cause, cause_no, cause_sep, group_cause) %>% 
  filter(group_cause != "ambiguous",
         group_type != "ambiguous")
```

## Write processed datafile for analysis

```{r}
# write_tsv(processed_cause_type_relationship, "Processed/ReMis_Main_Processed_Cause_Type_Relationship_Analysis_data.tsv")
```

## Create datatable for exploring the relationship between mistake types and outcomes

```{r}
# Filtering outcomes for the plot
processed_outcome_groups_filtered <-
  processed_outcome_groups %>%
  group_by(response_id, type) %>%
  mutate(n_outcome = n()) %>% 
  filter(n_outcome == 1)

# Filtering mistake types for the plot
processed_type_groups_filtered  <-
  processed_type_groups %>% 
  group_by(response_id, type) %>%
  slice(which.max(mistake_no)) %>%
  filter(mistake_no == 1)

# Create the datatable
processed_outcome_type_relationship <-
  processed_type_groups %>% 
  inner_join(., processed_outcome_groups_filtered, by = c("response_id", "type")) %>% 
  select(response_id, type, mistake, mistake_no, mistake_sep, group_type, outcome, outcome_no, outcome_sep, group_outcome) %>% 
  filter(group_outcome != "ambiguous",
         group_type != "ambiguous")
```

# Write processed datafile for analysis

```{r}
# write_tsv(processed_outcome_type_relationship, "Processed/ReMis_Main_Processed_Outcome_Type_Relationship_Analysis_data.tsv")
```

## Create datatable for the investigation of the frequency and seriousness of different mistake types

```{r}
# Keep only cases where the respondent wrote maximum 1 mistake
processed_type_groups_filtered  <-
  processed_type_groups %>% 
  group_by(response_id, type) %>%
  slice(which.max(mistake_no)) %>%
  filter(mistake_no == 1)

# Transform data
processed_type <-
  processed_type_groups_filtered %>% 
  inner_join(., processed_mistake_general_excluded, by = c("response_id", "type", "mistake")) %>% 
  select(response_id, type, mistake, mistake_no, mistake_sep, group_type, question, rating)
```

# Write processed datafile for analysis

```{r}
# write_tsv(processed_type, "Processed/ReMis_Main_Processed_Type_Analysis_data.tsv")
```