---
title: "ReMis_Main_processed_Analysed"
author: "Marton Kovacs"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: html_document
---

# Load packages

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(readxl)
library(qdap)
library(papaja)
library(skimr)
library(viridis)
```

# Load functions

```{r}
source("utils.R")
```

# Descriptives of the sample
## Read in data

```{r}
descriptives <- read_tsv("Data/Processed/ReMis_Main_Processed_Descriptive_data.tsv")
```

## The number of distinct respondents

```{r}
descriptives %>% 
  distinct(response_id) %>% 
  count()
```

## Data descriptives

```{r}
skim(descriptives)
```

## Years in field descriptives

```{r}
descriptives %>% 
  summarise(median_year = median(years))
```

## Years spent on the field

```{r}
### Histogram
descriptives %>% 
  ggplot() +
  aes(years) +
  geom_histogram() +
  labs(x = "Years Spent in the Field",  y = "Count") +
  scale_y_continuous(expand = c(0,0)) +
  theme(axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black", size = 12),
        axis.title = element_text(size = 15),
        panel.background = element_blank())
```

Saving the plot.

```{r}
ggsave("Figures/years_on_field_plot.png", width = 14.4, height = 9, plot = last_plot())
```

## Field

Distribution of the subfield of the respondents.

```{r}
descriptives %>% 
  group_by(field) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 2)) %>% 
  arrange(desc(n))
```

Plotting the distribution.

```{r}
descriptives %>% 
  filter(!is.na(field)) %>% 
  mutate(field = case_when(field == "other" ~ "Other",
                           field == "experimental and cognitive psychology" ~ "Experimental and\nCognitive Psychology",
                           field == "social psychology" ~ "Social Psychology",
                           field == "clinical psychology" ~ "Clinical Psychology",
                           field == "developmental and educational psychology" ~ "Developmental and\nEducational Psychology",
                           field == "applied psychology" ~ "Applied Psychology",
                           field == "neurophysiology and physiological psychology" ~ "Neurophysiology and\nPhysiological Psychology",
                           field == "methodology and statistics" ~ "Methodology and Statistics",
                           field == "personality psychology" ~ "Personality Psychology")) %>% 
  group_by(field) %>% 
  count() %>% 
  ggplot(.) +
  aes(x = reorder(field, desc(n)), y = n) +
  geom_bar(stat = "identity") +
  scale_y_continuous(expand = c(0,0), limits = c(0, 120)) +
  labs(x = "Field of the Research Teams of the Respondents",
       y = "Count") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black", size = 12),
        axis.title = element_text(size = 15),
        panel.background = element_blank())
```

Saving the plot.

```{r}
ggsave("Figures/subfield_distribution_plot.png", width = 14.4, height = 9, plot = last_plot())
```

# General overview of data management mistakes
## General frequency of mistakes
### Import data

```{r}
general_mistake_frequency <- read_tsv("Data/Processed/ReMis_Main_Processed_General_Frequency_data.tsv")
```

### Relevel factor variable for plotting

```{r}
general_mistake_frequency <- 
  general_mistake_frequency %>% 
  mutate(general_frequency = frequency_char_to_fact(general_frequency))
```

Checking the levels of the answer option to general_frequency.

```{r}
distinct(general_mistake_frequency, general_frequency)
```

### Descriptive results

```{r}
general_mistake_frequency %>%
  filter(!is.na(general_frequency)) %>%
  group_by(general_frequency) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0))
```

```{r}
general_mistake_frequency_plot <- 
  general_mistake_frequency %>% 
  filter(!is.na(general_frequency)) %>% 
  group_by(general_frequency) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0)) %>% 
  ggplot() +
  aes(x = general_frequency, y = percentage) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(percentage, "%")), size = 8, hjust=-0.3) +
  scale_y_continuous(expand = c(0,0), limit = c(0, 75), breaks = c(0, 20, 40, 60, 75), labels = scales::label_percent(scale = 1)) +
  labs(x = "Frequency Level",
       title = "Overall Frequency (n = 463)") +
  coord_flip() +
  theme(axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black", size = 18),
        axis.title = element_text(size = 20),
        panel.background = element_blank(),
        axis.title.x = element_blank(),
        plot.margin = unit(c(0,0.8,0,0), "cm"),
        title = element_text(color = "black", size = 20))

general_mistake_frequency_plot
```

```{r}
general_mistake_frequency %>%
  filter(!is.na(general_frequency)) %>% 
  mutate(report_group = case_when(general_frequency == "Very Low" ~ 1L,
                                  general_frequency == "Low" ~ 1L,
                                  general_frequency == "Moderate" ~ 0L,
                                  general_frequency == "High" ~ 0L,
                                  general_frequency == "Very High" ~ 0L)) %>% 
  group_by(report_group) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

## Analysis of the most frequent mistakes
### Read in data

```{r}
general_mistake_overview <- read_tsv("Data/Processed/ReMis_Main_Processed_Mistake_General_data.tsv")
```

### Number of responses to each investigated question

```{r}
general_mistake_overview %>% 
  group_by(type, question) %>% 
  count()
```

### Levels of the answer option to recurring_frequency

```{r}
general_mistake_overview %>% 
  filter(type == "recurring",
         question == "frequency") %>% 
  distinct(rating)
```

### Proportion of the frequency of the most recurring mistakes

```{r}
general_mistake_overview %>%
  filter(type == "recurring",
         question == "frequency",
         !is.na(rating)) %>% 
  mutate(rating = frequency_char_to_fact(rating)) %>% 
  group_by(rating) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0))
```

### Barplot of responses of the frequency of the most recurring mistakes

```{r} 
most_frequent_frequency_plot <- 
  general_mistake_overview %>%
  filter(type == "recurring",
         question == "frequency",
         !is.na(rating)) %>% 
  mutate(rating = frequency_char_to_fact(rating)) %>% 
  group_by(rating) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0)) %>% 
  ggplot() +
  aes(x = rating, y = percentage) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(percentage, "%")), size = 8, hjust=-0.3) +
  labs(title = "Most Frequent Mistakes (n = 397)") +
  scale_y_continuous(expand = c(0,0), limit = c(0, 75), breaks = c(0, 20, 40, 60, 75), labels = scales::label_percent(scale = 1)) +
  coord_flip() +
  theme(axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black", size = 18),
        panel.background = element_blank(),
        axis.title = element_blank(),
        plot.margin = unit(c(0,0.8,0,0), "cm"),
        title = element_text(color = "black", size = 20))

most_frequent_frequency_plot
```

```{r}
general_mistake_overview %>%
  filter(type == "recurring",
         question == "frequency",
         !is.na(rating)) %>% 
  mutate(rating = frequency_char_to_fact(rating)) %>% 
  mutate(report_group = case_when(rating == "Very Low" ~ 1L,
                                  rating == "Low" ~ 1L,
                                  rating == "Moderate" ~ 0L,
                                  rating == "High" ~ 0L,
                                  rating == "Very High" ~ 0L)) %>%
  group_by(report_group) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

### Levels of the answer option to recurring_serious

```{r}
general_mistake_overview %>% 
  filter(type == "recurring",
         question == "serious") %>% 
  distinct(rating)
```

### Proportion of the most recurring mistakes on a given seriousness level throughout research data management

```{r}
general_mistake_overview %>%
  filter(type == "recurring",
         question == "serious",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_fact(rating)) %>% 
  group_by(rating) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = n / N * 100)
```

### Barplot of responses of the seriousness of the most recurring mistakes

```{r}
most_frequent_seriousness_plot <- 
  general_mistake_overview %>% 
  filter(type == "recurring",
         question == "serious",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_fact(rating)) %>% 
  group_by(rating) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0)) %>% 
  ggplot() +
  aes(rating, percentage) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(percentage, "%")), size = 8, hjust=-0.3) +
  scale_y_continuous(expand = c(0,0), limit = c(0, 75), breaks = c(0, 20, 40, 60, 75), labels = scales::label_percent(scale = 1)) +
  labs(y = "Percentage",
       title = "Most Frequent Mistakes (n = 397)") +
  coord_flip() +
  theme(axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black", size = 18),
        axis.title = element_text(size = 20),
        panel.background = element_blank(),
        axis.title.y = element_blank(),
        plot.margin = unit(c(0,0.8,0,0), "cm"),
        title = element_text(color = "black", size = 20))

most_frequent_seriousness_plot
```

```{r}
general_mistake_overview %>%
  filter(type == "recurring",
         question == "serious",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_fact(rating)) %>% 
  mutate(report_group = case_when(rating == "Insignificant" ~ 1L,
                                  rating == "Minor" ~ 1L,
                                  rating == "Moderate" ~ 0L,
                                  rating == "Major" ~ 0L,
                                  rating == "Extreme" ~ 0L)) %>%
  group_by(report_group) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

### Median rating of all the most recurring mistakes

```{r}
general_mistake_overview %>% 
  filter(type == "recurring",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_int(rating)) %>%
  group_by(question) %>% 
  summarize(median = median(rating, na.rm = TRUE),
            max = max(rating, na.rm = TRUE),
            min = min(rating, na.rm = TRUE),
            n = n(),
            quart1 = quantile(rating, 0.25, na.rm = TRUE),
            quart3 = quantile(rating, 0.75, na.rm = TRUE),
            IQR = IQR(rating, na.rm = TRUE))
```

## Analysis of the most serious mistakes

### Proportion of the most serious mistakes on a given seriousness level throughout research data management

```{r}
general_mistake_overview %>%
  filter(type == "serious",
         question == "serious",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_fact(rating)) %>%
  group_by(rating) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0))
```

### Barplot of responses to serious_serious

```{r}
most_serious_seriousness_plot <- 
  general_mistake_overview %>% 
  filter(type == "serious",
         question == "serious",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_fact(rating)) %>%
  group_by(rating) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         percentage = round(n / N * 100, 0)) %>% 
  ggplot() +
  aes(rating, percentage) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(percentage, "%")), size = 8, hjust=-0.3) +
  scale_y_continuous(expand = c(0,0), limit = c(0, 75), breaks = c(0, 20, 40, 60, 75), labels = scales::label_percent(scale = 1)) +
  labs(x = "Seriousness Level",
       y = "Percentage",
       title = "Most Serious Mistakes (n = 277)") +
  coord_flip() +
  theme(axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black"),
        axis.text = element_text(color = "black", size = 18),
        axis.title = element_text(size = 20),
        panel.background = element_blank(),
        plot.margin = unit(c(0,0.8,0,0), "cm"),
        title = element_text(color = "black", size = 20))

most_serious_seriousness_plot
```

```{r}
general_mistake_overview %>%
  filter(type == "serious",
         question == "serious",
         !is.na(rating)) %>% 
  mutate(rating = serious_char_to_fact(rating)) %>% 
  mutate(report_group = case_when(rating == "Insignificant" ~ 1L,
                                  rating == "Minor" ~ 1L,
                                  rating == "Moderate" ~ 0L,
                                  rating == "Major" ~ 0L,
                                  rating == "Extreme" ~ 0L)) %>%
  group_by(report_group) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

```{r}
cowplot::plot_grid(general_mistake_frequency_plot, most_frequent_frequency_plot,
                   most_serious_seriousness_plot, most_frequent_seriousness_plot, ncol = 2, align = "hv")
```

```{r}
ggsave("Figures/overview_mistakes_plot.png", width = 14.4, height = 9, plot = last_plot())
```

# Investigating research data management mistake types
## Relationship between mistake types by mistake causes
### Read in processed data

```{r}
cause_type_relationship <- read_tsv( "Data/Processed/ReMis_Main_Processed_Cause_Type_Relationship_Analysis_data.tsv")
```

### Data descriptives

```{r}
skim(cause_type_relationship) %>% summary()

skim(cause_type_relationship)
```

### Data transformation

For the plot we are recoding the different cause groups to match APA 6th format.

```{r}
cause_type_relationship <- 
  cause_type_relationship %>% 
  mutate(group_cause_meta = case_when(group_cause == "lack of knowledge/experience" ~ "Lack of knowledge",
                                      group_cause == "bad or lack of planning" ~ "Poor project preparation\nor management",
                                      group_cause == "bad or lack of standards" ~ "Poor project preparation\nor management",
                                      group_cause == "bad skill management" ~ "Poor project preparation\nor management",
                                      group_cause == "miscommunication" ~ "Poor project preparation\nor management",
                                      group_cause == "project management issue" ~ "Poor project preparation\nor management",
                                      group_cause == "time management issue" ~ "Poor project preparation\nor management",
                                      group_cause == "risking human error" ~ "Poor project preparation\nor management",
                                      group_cause == "technical issue" ~ "External difficulties",
                                      group_cause == "too high complexity" ~ "External difficulties",
                                      group_cause == "inattention" ~ "Personal difficulties",
                                      group_cause == "carelessness" ~ "Personal difficulties",
                                      group_cause == "overconfidence" ~ "Personal difficulties",
                                      group_cause == "physical and mental constraints" ~ "Personal difficulties",
                                      group_cause == "lack of control" ~ "Personal difficulties"))
```

Calculating the proportions of meta-causes in the sample.

```{r}
cause_type_relationship %>% 
  group_by(group_cause_meta) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100) %>% 
  arrange(desc(n))
```

Counting how many respondents listed a specific cause for each mistake type.

```{r}
con_tab <- as_tibble(xtabs(~ group_type + group_cause_meta, data = cause_type_relationship))
```

Calculating the percentages for each count.

```{r}
relationship_plot_data <- 
  con_tab %>% 
  group_by(group_type) %>% 
  mutate(n_sum = sum(n)) %>% 
  ungroup() %>%
  mutate(prop = n / n_sum) %>%
  filter(n_sum >= 10)
```

Check if the proportion of the cause groups add up to a hundred.

```{r}
relationship_plot_data %>% 
  group_by(group_type) %>% 
  summarise(sum_prop = sum(prop))
```

Creating labels for the plots' Y axis with the different mistake types and their count in this analysis.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  mutate(label = paste0(group_type, " (", n_sum, ")"))
```

Drop cases where the mistake type-cause connection is not present.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  filter(n != 0)
```

### Creating the plot

```{r, fig.show = 'hide'}
relationship_plot_data %>% 
    ggplot(aes(x = reorder(label, n), y = prop, group = group_cause_meta, fill = group_cause_meta)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(discrete = TRUE) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = scales::percent(c(0, 0.25, 0.5, 0.75, 1))) +
    coord_flip() +
    labs(x = "Data Management Mistake Types",
         y = "Percentage",
         fill = "Cause Meta-Groups") +
    theme(axis.text.x = element_text(size = 18, color = "black"),
          axis.text.y = element_text(size = 18, color = "black"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.ticks = element_line(color = "black"),
          axis.line = element_line(color = "black"),
          legend.title = element_text(size = 18),
          axis.title = element_text(size = 20, color = "black"),
          legend.text = element_text(size = 18),
          legend.position = c(.2, -.13),
          legend.direction = "horizontal",
          plot.margin = unit(c(0,0.9,2,0), "cm")) +
  guides(fill = guide_legend(reverse=TRUE))
```

Saving the plot.

```{r}
ggsave("Figures/cause_type_relationship_plot.png", width = 14.4, height = 9, plot = last_plot())
```

### Same figure separately for the most frequent mistakes

Filter the most frequent mistakes only.

```{r}
frequent_cause_type_relationship <- 
  cause_type_relationship %>% 
  filter(type == "recurring")
```

Counting how many respondents listed a specific cause for each mistake type.

```{r}
con_tab <- as_tibble(xtabs(~ group_type + group_cause_meta, data = frequent_cause_type_relationship))
```

Calculating the percentages for each count.

```{r}
relationship_plot_data <- 
  con_tab %>% 
  group_by(group_type) %>% 
  mutate(n_sum = sum(n)) %>% 
  ungroup() %>%
  mutate(prop = n / n_sum) %>%
  filter(n_sum >= 10)
```

Check if the proportion of the cause groups add up to a hundred.

```{r}
relationship_plot_data %>% 
  group_by(group_type) %>% 
  summarise(sum_prop = sum(prop))
```

Creating labels for the plots' Y axis with the different mistake types and their count in this analysis.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  mutate(label = paste0(group_type, " (", n_sum, ")"))
```

Drop cases where the mistake type-cause connection is not present.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  filter(n != 0)
```

#### Creating the plot

```{r, fig.show = 'hide'}
relationship_plot_data %>% 
    ggplot(aes(x = reorder(label, n), y = prop, group = group_cause_meta, fill = group_cause_meta)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(discrete = TRUE) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = scales::percent(c(0, 0.25, 0.5, 0.75, 1))) +
    coord_flip() +
    labs(x = "Data Management Mistake Types",
         y = "Percentage",
         fill = "Cause Meta-Groups") +
    theme(axis.text.x = element_text(size = 18, color = "black"),
          axis.text.y = element_text(size = 18, color = "black"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.ticks = element_line(color = "black"),
          axis.line = element_line(color = "black"),
          legend.title = element_text(size = 18),
          axis.title = element_text(size = 20, color = "black"),
          legend.text = element_text(size = 18),
          legend.position = c(.2, -.13),
          legend.direction = "horizontal",
          plot.margin = unit(c(0,0.9,2.2,0), "cm")) +
  guides(fill = guide_legend(reverse=TRUE))
```

Saving the plot.

```{r}
ggsave("Figures/frequent_cause_type_relationship_plot.png", width = 14.4, height = 9, plot = last_plot())
```

### Same figure separately for the most serious mistakes

Filter the most serious mistakes only.

```{r}
serious_cause_type_relationship <- 
  cause_type_relationship %>% 
  filter(type == "serious")
```

Counting how many respondents listed a specific cause for each mistake type.

```{r}
con_tab <- as_tibble(xtabs(~ group_type + group_cause_meta, data = serious_cause_type_relationship))
```

Calculating the percentages for each count.

```{r}
relationship_plot_data <- 
  con_tab %>% 
  group_by(group_type) %>% 
  mutate(n_sum = sum(n)) %>% 
  ungroup() %>%
  mutate(prop = n / n_sum) %>%
  filter(n_sum >= 10)
```

Check if the proportion of the cause groups add up to a hundred.

```{r}
relationship_plot_data %>% 
  group_by(group_type) %>% 
  summarise(sum_prop = sum(prop))
```

Creating labels for the plots' Y axis with the different mistake types and their count in this analysis.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  mutate(label = paste0(group_type, " (", n_sum, ")"))
```

Drop cases where the mistake type-cause connection is not present.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  filter(n != 0)
```

#### Creating the plot

```{r, fig.show = 'hide'}
relationship_plot_data %>% 
    ggplot(aes(x = reorder(label, n), y = prop, group = group_cause_meta, fill = group_cause_meta)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(discrete = TRUE) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = scales::percent(c(0, 0.25, 0.5, 0.75, 1))) +
    coord_flip() +
    labs(x = "Data Management Mistake Types",
         y = "Percentage",
         fill = "Cause Meta-Groups") +
    theme(axis.text.x = element_text(size = 18, color = "black"),
          axis.text.y = element_text(size = 18, color = "black"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.ticks = element_line(color = "black"),
          axis.line = element_line(color = "black"),
          legend.title = element_text(size = 18),
          axis.title = element_text(size = 20, color = "black"),
          legend.text = element_text(size = 18),
          legend.position = c(.2, -.13),
          legend.direction = "horizontal",
          plot.margin = unit(c(0,0.9,2.2,0), "cm")) +
  guides(fill = guide_legend(reverse=TRUE))
```

Saving the plot.

```{r}
ggsave("Figures/serious_cause_type_relationship_plot.png", width = 14.4, height = 9, plot = last_plot())
```

## Relationship between mistake types and mistake outcomes
### Read in processed data

```{r}
outcome_type_relationship <- read_tsv("Data/Processed/ReMis_Main_Processed_Outcome_Type_Relationship_Analysis_data.tsv")
```

### Data descriptives

```{r}
skim(outcome_type_relationship) %>% summary()

skim(outcome_type_relationship)
```

Calculating the proportions of meta-causes in the sample.

```{r}
outcome_type_relationship %>% 
  group_by(group_outcome) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100) %>% 
  arrange(desc(n))
```

### Data transformation

Counting how many respondents listed a specific cause for each mistake type

```{r}
con_tab <- as_tibble(xtabs(~ group_type + group_outcome, data = outcome_type_relationship))
```

Calculating the percentages for each count.

```{r}
relationship_plot_data <-
  con_tab %>% 
  group_by(group_type) %>% 
  mutate(n_sum = sum(n)) %>% 
  ungroup() %>%
  mutate(prop = n / n_sum) %>%
  filter(n_sum >= 10) %>%
  mutate(group_outcome = case_when(group_outcome == "financial lost" ~ "financial loss",
                                   TRUE ~ group_outcome))
```

Check if the proportion of the cause groups add up to a hundred.

```{r}
relationship_plot_data %>% 
  group_by(group_type) %>% 
  summarise(sum_prop = sum(prop))
```

Creating labels for the plots' Y axis with the different mistake types and their count in this analysis.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  mutate(label = paste0(group_type, " (", n_sum, ")"))
```

Drop cases where the mistake type-outcome connection is not present.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  filter(n != 0)
```

### Creating the plot

```{r, fig.show = 'hide'}
relationship_plot_data %>% 
    ggplot(aes(x = reorder(label, n), y = prop, group = group_outcome, fill = group_outcome)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(discrete = TRUE) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = scales::percent(c(0, 0.25, 0.5, 0.75, 1))) +
    coord_flip() +
    labs(x = "Data Management Mistake Types",
         y = "Percentage",
         fill = "Outcome Groups") +
    theme(axis.text.x = element_text(size = 18, color = "black"),
          axis.text.y = element_text(size = 18, color = "black"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.ticks = element_line(color = "black"),
          axis.line = element_line(color = "black"),
          axis.title = element_text(size = 20, color = "black"),
          legend.title = element_text(size = 18),
          legend.text = element_text(size = 18),
          legend.position = c(.2, -.13),
          legend.direction = "horizontal",
          plot.margin = unit(c(0,0.9,2.2,0), "cm")) +
  guides(fill = guide_legend(reverse=TRUE))
```

Saving the plot.

```{r}
ggsave("Figures/outcome_type_relationship_plot.png", width = 14.4, height = 9, plot = last_plot())
```

### Same figure separately for the most frequent mistakes

Filter the most frequent mistakes only.

```{r}
frequent_outcome_type_relationship <- 
  outcome_type_relationship %>% 
  filter(type == "recurring")
```

#### Data transformation

Counting how many respondents listed a specific cause for each mistake type

```{r}
con_tab <- as_tibble(xtabs(~ group_type + group_outcome, data = frequent_outcome_type_relationship))
```

Calculating the percentages for each count.

```{r}
relationship_plot_data <-
  con_tab %>% 
  group_by(group_type) %>% 
  mutate(n_sum = sum(n)) %>% 
  ungroup() %>%
  mutate(prop = n / n_sum) %>%
  filter(n_sum >= 10) %>% 
  mutate(group_outcome = case_when(group_outcome == "financial lost" ~ "financial loss",
                                   TRUE ~ group_outcome))
```

Check if the proportion of the cause groups add up to a hundred.

```{r}
relationship_plot_data %>% 
  group_by(group_type) %>% 
  summarise(sum_prop = sum(prop))
```

Creating labels for the plots' Y axis with the different mistake types and their count in this analysis.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  mutate(label = paste0(group_type, " (", n_sum, ")"))
```

Drop cases where the mistake type-outcome connection is not present.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  filter(n != 0)
```

#### Creating the plot

```{r, fig.show = 'hide'}
relationship_plot_data %>% 
    ggplot(aes(x = reorder(label, n), y = prop, group = group_outcome, fill = group_outcome)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(discrete = TRUE) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = scales::percent(c(0, 0.25, 0.5, 0.75, 1))) +
    coord_flip() +
    labs(x = "Data Management Mistake Types",
         y = "Percentage",
         fill = "Outcome Groups") +
    theme(axis.text.x = element_text(size = 18, color = "black"),
          axis.text.y = element_text(size = 18, color = "black"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.ticks = element_line(color = "black"),
          axis.line = element_line(color = "black"),
          axis.title = element_text(size = 20, color = "black"),
          legend.title = element_text(size = 18),
          legend.text = element_text(size = 18),
          legend.position = c(.2, -.13),
          legend.direction = "horizontal",
          plot.margin = unit(c(0,0.9,2.2,0), "cm")) +
  guides(fill = guide_legend(reverse=TRUE))
```

Saving the plot.

```{r}
ggsave("Figures/frequent_outcome_type_relationship_plot.png", width = 14.4, height = 9, plot = last_plot())
```

### Same figure separately for the most serious mistakes

Filter the most frequent mistakes only.

```{r}
serious_outcome_type_relationship <- 
  outcome_type_relationship %>% 
  filter(type == "serious")
```

#### Data transformation

Counting how many respondents listed a specific cause for each mistake type

```{r}
con_tab <- as_tibble(xtabs(~ group_type + group_outcome, data = serious_outcome_type_relationship))
```

Calculating the percentages for each count.

```{r}
relationship_plot_data <-
  con_tab %>% 
  group_by(group_type) %>% 
  mutate(n_sum = sum(n)) %>% 
  ungroup() %>%
  mutate(prop = n / n_sum) %>%
  filter(n_sum >= 10) %>% 
  mutate(group_outcome = case_when(group_outcome == "financial lost" ~ "financial loss",
                                   TRUE ~ group_outcome))
```

Check if the proportion of the outcome groups add up to a hundred.

```{r}
relationship_plot_data %>% 
  group_by(group_type) %>% 
  summarise(sum_prop = sum(prop))
```

Creating labels for the plots' Y axis with the different mistake types and their count in this analysis.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  mutate(label = paste0(group_type, " (", n_sum, ")"))
```

Drop cases where the mistake type-outcome connection is not present.

```{r}
relationship_plot_data <- 
  relationship_plot_data %>% 
  filter(n != 0)
```

#### Creating the plot

```{r, fig.show = 'hide'}
relationship_plot_data %>% 
    ggplot(aes(x = reorder(label, n), y = prop, group = group_outcome, fill = group_outcome)) +
    geom_bar(stat = "identity") +
    viridis::scale_fill_viridis(discrete = TRUE) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 1), breaks = c(0, 0.25, 0.5, 0.75, 1), labels = scales::percent(c(0, 0.25, 0.5, 0.75, 1))) +
    coord_flip() +
    labs(x = "Data Management Mistake Types",
         y = "Percentage",
         fill = "Outcome Groups") +
    theme(axis.text.x = element_text(size = 18, color = "black"),
          axis.text.y = element_text(size = 18, color = "black"),
          panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.ticks = element_line(color = "black"),
          axis.line = element_line(color = "black"),
          axis.title = element_text(size = 20, color = "black"),
          legend.title = element_text(size = 18),
          legend.text = element_text(size = 18),
          legend.position = c(.2, -.13),
          legend.direction = "horizontal",
          plot.margin = unit(c(0,0.9,2.2,0), "cm")) +
  guides(fill = guide_legend(reverse=TRUE))
```

Saving the plot.

```{r}
ggsave("Figures/serious_outcome_type_relationship_plot.png", width = 14.4, height = 9, plot = last_plot())
```

## Frequency of data management mistak types
### Read data

```{r}
mistake_type_groups <- read_tsv("Data/Processed/ReMis_Main_Processed_Type_Groups_data.tsv")
```

### Counting how many times a mistake type is reported for the most frequent mistakes

```{r}
mistake_type_groups %>% 
  filter(type == "recurring") %>% 
  group_by(group_type) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n))
```

### Counting how many times a mistake type is reported for the most serious mistakes

```{r}
mistake_type_groups %>% 
  filter(type == "serious") %>% 
  group_by(group_type) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n))
```

### Counting how many times a mistake type is reported for the most frequent and most serious mistakes

```{r}
mistake_type_groups %>% 
  group_by(group_type) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

## Frequency of cause groups
### Read data

```{r}
cause_groups <- read_tsv("Data/Processed/ReMis_Main_Processed_Cause_Groups_data.tsv")
```

### Counting how many times a cause is reported for the most frequent mistakes

```{r}
cause_groups %>% 
  filter(type == "recurring") %>% 
  group_by(group_cause) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n))
```

### Counting how many times a cause group is reported for the most serious mistakes

```{r}
cause_groups %>% 
  filter(type == "serious") %>% 
  group_by(group_cause) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n))
```

### Counting how many times a cause group is reported for the most frequent and most serious mistakes

```{r}
cause_groups %>% 
  group_by(group_cause) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```

## Frequency of outcome groups
### Read data

```{r}
outcome_groups <- read_tsv("Data/Processed/ReMis_Main_Processed_Outcome_Groups_data.tsv")
```

### Counting how many times an outcome group is reported for the most frequent mistakes

```{r}
outcome_groups %>% 
  filter(type == "recurring") %>% 
  group_by(group_outcome) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n))
```

### Counting how many times an outcome group is reported for the most serious mistakes

```{r}
outcome_groups %>% 
  filter(type == "serious") %>% 
  group_by(group_outcome) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n))
```

### Counting how many times an outcome group is reported for the most frequent and most serious mistakes

```{r}
outcome_groups %>% 
  group_by(group_outcome) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>% 
  mutate(N = sum(n),
         prop = n / N * 100)
```